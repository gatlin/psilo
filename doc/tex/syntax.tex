\documentclass[]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
    \usepackage{xltxtra,xunicode}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Mapping=tex-text,Scale=MatchLowercase}
  \newcommand{\euro}{â‚¬}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\newenvironment{Shaded}{}{}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
\newcommand{\RegionMarkerTok}[1]{{#1}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
\newcommand{\NormalTok}[1]{{#1}}
\ifxetex
  \usepackage[setpagesize=false, % page size defined by xetex
              unicode=false, % unicode breaks when used with xetex
              xetex]{hyperref}
\else
  \usepackage[unicode=true]{hyperref}
\fi
\hypersetup{breaklinks=true,
            bookmarks=true,
            pdfauthor={},
            pdftitle={Expression syntax},
            colorlinks=true,
            citecolor=blue,
            urlcolor=blue,
            linkcolor=magenta,
            pdfborder={0 0 0}}
\urlstyle{same}  % don't use monospace font for urls
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\setcounter{secnumdepth}{0}

\title{Expression syntax}
\date{}

\begin{document}
\maketitle

The AST is a non-recursive data type. To add recursion to psilo's
syntax, I could use the Mu combinator, which is the type-level
equivalent of the Y combinator:

\begin{verbatim}
newtype Mu f = Mu (f (Mu f))
type Expr = Mu AST
\end{verbatim}

However, it so happens that the Free monad has a very similar
definition:

\begin{verbatim}
data Free f a = Pure a | Free (f (Free f a))
\end{verbatim}

Note the second constructor. So, instead, I use \texttt{Free}.

The \texttt{Free} monad constructor takes any \texttt{Functor} type and
yields a monad for ``free'': you get generic instances of the
\texttt{\textgreater{}\textgreater{}=} and \texttt{return} functions.
These essentially build up values layer by layer and do not give your
type any evaluation semantics.

Instead, it is on the programmer to write an interpreter function to
unwrap and perform some computation on these values. This is exactly
what the \texttt{interpreter} function from the \texttt{Evaluator}
module does.

Thus, by using \texttt{Free}, not only do I get a recursive syntax
definition with minimal complexity but I also get a suite of tools for
building up expressions in my syntax and then tearing them down to yield
a result, including \texttt{do} notation.

Not bad, huh?

\begin{Shaded}
\begin{Highlighting}[]
\OtherTok{\{-# LANGUAGE DeriveFunctor #-\}}
\OtherTok{\{-# LANGUAGE DeriveFoldable #-\}}
\OtherTok{\{-# LANGUAGE DeriveTraversable #-\}}
\OtherTok{\{-# LANGUAGE StandaloneDeriving #-\}}
\OtherTok{\{-# LANGUAGE TypeSynonymInstances #-\}}
\OtherTok{\{-# LANGUAGE FlexibleInstances #-\}}
\OtherTok{\{-# LANGUAGE OverlappingInstances #-\}}

\KeywordTok{module} \DataTypeTok{Syntax} \KeywordTok{where}

\KeywordTok{import }\DataTypeTok{Prelude} \KeywordTok{hiding} \NormalTok{(sequence)}
\KeywordTok{import }\DataTypeTok{Control.Monad.Free}
\KeywordTok{import }\DataTypeTok{Data.Foldable} \NormalTok{(}\DataTypeTok{Foldable}\NormalTok{, fold)}
\KeywordTok{import }\DataTypeTok{Data.Traversable} \NormalTok{(}\DataTypeTok{Traversable}\NormalTok{, sequence)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{type} \DataTypeTok{Symbol} \FunctionTok{=} \DataTypeTok{String}

\KeywordTok{data} \DataTypeTok{AST} \NormalTok{a}
    \FunctionTok{=} \DataTypeTok{AInteger} \DataTypeTok{Integer}
    \FunctionTok{|} \DataTypeTok{ABoolean} \DataTypeTok{Bool}
    \FunctionTok{|} \DataTypeTok{ASymbol} \NormalTok{\{}\OtherTok{ toSym ::} \DataTypeTok{Symbol} \NormalTok{\}}
    \FunctionTok{|} \DataTypeTok{ALambda} \NormalTok{[}\DataTypeTok{Symbol}\NormalTok{] a}
    \FunctionTok{|} \DataTypeTok{AApply} \NormalTok{a a}
    \FunctionTok{|} \DataTypeTok{AList} \NormalTok{[a]}

\KeywordTok{deriving} \KeywordTok{instance} \DataTypeTok{Show} \NormalTok{a }\OtherTok{=>} \DataTypeTok{Show} \NormalTok{(}\DataTypeTok{AST} \NormalTok{a)}
\KeywordTok{deriving} \KeywordTok{instance} \DataTypeTok{Functor} \DataTypeTok{AST}
\KeywordTok{deriving} \KeywordTok{instance} \DataTypeTok{Foldable} \DataTypeTok{AST}
\KeywordTok{deriving} \KeywordTok{instance} \DataTypeTok{Traversable} \DataTypeTok{AST}
\KeywordTok{deriving} \KeywordTok{instance} \DataTypeTok{Eq} \NormalTok{a }\OtherTok{=>} \DataTypeTok{Eq} \NormalTok{(}\DataTypeTok{AST} \NormalTok{a)}
\KeywordTok{deriving} \KeywordTok{instance} \DataTypeTok{Ord} \NormalTok{a }\OtherTok{=>} \DataTypeTok{Ord} \NormalTok{(}\DataTypeTok{AST} \NormalTok{a)}

\KeywordTok{type} \DataTypeTok{Expr} \FunctionTok{=} \DataTypeTok{Free} \DataTypeTok{AST}

\KeywordTok{instance} \DataTypeTok{Show} \NormalTok{a }\OtherTok{=>} \DataTypeTok{Show} \NormalTok{(}\DataTypeTok{Expr} \NormalTok{a) }\KeywordTok{where}
    \NormalTok{show (}\DataTypeTok{Pure} \NormalTok{_)   }\FunctionTok{=} \StringTok{""}
    \NormalTok{show (}\DataTypeTok{Free} \NormalTok{x) }\FunctionTok{=} \StringTok{" ( "} \FunctionTok{++} \NormalTok{show x }\FunctionTok{++} \StringTok{" ) "}
\end{Highlighting}
\end{Shaded}

The need occasionally arises to convert a list of
\texttt{Free (ASymbol Symbol)} values to a list of \texttt{Symbol}
values. This function serves that purpose:

\begin{Shaded}
\begin{Highlighting}[]
\OtherTok{expr2symlist ::} \NormalTok{[}\DataTypeTok{Expr} \NormalTok{a] }\OtherTok{->} \NormalTok{[}\DataTypeTok{Symbol}\NormalTok{]}
\NormalTok{expr2symlist ((}\DataTypeTok{Free} \NormalTok{(}\DataTypeTok{ASymbol} \NormalTok{x))}\FunctionTok{:}\NormalTok{xs) }\FunctionTok{=} \NormalTok{[x] }\FunctionTok{++} \NormalTok{(expr2symlist xs)}
\NormalTok{expr2symlist _                       }\FunctionTok{=} \NormalTok{[]}
\end{Highlighting}
\end{Shaded}

\end{document}
