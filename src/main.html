<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>psilo | psilo</title>

    <!-- Bootstrap core CSS -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="../css/jumbotron-narrow.css" rel="stylesheet">

    <!-- glyphicons -->
    <link href="../css/bootstrap-glyphicons.css" rel="stylesheet">

    <link href="../css/style.css" rel="stylesheet">
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #0000ff; }
code > span.ch { color: #008080; }
code > span.st { color: #008080; }
code > span.co { color: #008000; }
code > span.ot { color: #ff4000; }
code > span.al { color: #ff0000; }
code > span.er { font-weight: bold; }
    code{white-space: pre;}
  </style>
  </head>

  <body>

    <div class="container">
      <ol class="breadcrumb">
          <li><a href="/">home</a></li>
          <li><a href="/psilo/">psilo</a></li>
      </ol>
      <div class="page-header col-md-12 col-lg-10 col-lg-offset-1">
        <h1>
psilo
        </h1>
      </div>
      <div class="row">
        <div id="content" class="col-md-12 col-lg-10 col-lg-offset-1">

<p>This is the main program outline. If an argument is present on the command line then we execute the program in that file and halt. Otherwise we fire up a repl.</p>
<pre class="sourceCode literate haskell"><code class="sourceCode haskell"><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">Parser</span>
<span class="kw">import </span><span class="dt">Syntax</span>
<span class="kw">import </span><span class="dt">Evaluator</span>

<span class="kw">import </span><span class="dt">Control.Monad.Trans</span>
<span class="kw">import </span><span class="dt">System.Console.Haskeline</span>

<span class="kw">import </span><span class="dt">System.Environment</span>
<span class="kw">import </span><span class="dt">System.IO</span></code></pre>
<p><code>eval</code> amounts to taking a line of code (a line in the repl, an expression otherwise), getting the <code>Expr</code> value from the parser and then running a <code>Machine</code> with said value.</p>
<pre class="sourceCode literate haskell"><code class="sourceCode haskell"><span class="ot">eval ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
eval line <span class="fu">=</span> <span class="kw">do</span>
    <span class="kw">let</span> res <span class="fu">=</span> parseTopLevel line
    <span class="kw">case</span> res <span class="kw">of</span>
        <span class="dt">Left</span> err <span class="ot">-&gt;</span> print err
        <span class="dt">Right</span> ex <span class="ot">-&gt;</span> mapM_ execute (<span class="ot">ex ::</span> [<span class="dt">Expr</span> ()])

    <span class="kw">where</span> execute v <span class="fu">=</span> <span class="kw">do</span>
              (val, _) <span class="ot">&lt;-</span> runMachine <span class="fu">.</span> interpret <span class="fu">$</span> v
              putStrLn <span class="fu">.</span> show <span class="fu">$</span> val</code></pre>
<p>The repl is nothing more than calling <code>eval</code> in an endless loop.</p>
<pre class="sourceCode literate haskell"><code class="sourceCode haskell"><span class="ot">repl ::</span> <span class="dt">IO</span> ()
repl <span class="fu">=</span> runInputT defaultSettings loop
    <span class="kw">where</span>
    loop <span class="fu">=</span> <span class="kw">do</span>
        minput <span class="ot">&lt;-</span> getInputLine <span class="st">&quot;psilo&gt; &quot;</span>
        <span class="kw">case</span> minput <span class="kw">of</span>
            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> outputStrLn <span class="st">&quot;Goodbye.&quot;</span>
            <span class="dt">Just</span> input <span class="ot">-&gt;</span> (liftIO <span class="fu">$</span> eval input) <span class="fu">&gt;&gt;</span> loop</code></pre>
<p>If we execute <code>eval</code> on the contents of a file of code, we have a normal interpreter:</p>
<pre class="sourceCode literate haskell"><code class="sourceCode haskell"><span class="ot">execFile ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
execFile fname <span class="fu">=</span> readFile fname <span class="fu">&gt;&gt;=</span> eval</code></pre>
<pre class="sourceCode literate haskell"><code class="sourceCode haskell"><span class="ot">main ::</span> <span class="dt">IO</span> ()
main <span class="fu">=</span> <span class="kw">do</span>
    args <span class="ot">&lt;-</span> getArgs
    <span class="kw">case</span> args <span class="kw">of</span>
        []      <span class="ot">-&gt;</span> repl <span class="fu">&gt;&gt;</span> return ()
        [fname] <span class="ot">-&gt;</span> execFile fname <span class="fu">&gt;&gt;</span> return ()</code></pre>

        </div><!-- content -->
    </div><!-- row -->

      <div class="footer">
        <p>&copy; 2013-2014. Theme lovingly stolen from other people.</p>
      </div>

    </div> <!-- /container -->

  </body>
</html>
